<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JetQuest CAPTCHA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            touch-action: manipulation;
        }

        .captcha-container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .brand-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .brand-logo {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .brand-name {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .brand-tagline {
            font-size: 14px;
            color: #666;
        }

        .game-title {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }

        .instructions {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .route-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 12px;
        }

        .city {
            text-align: center;
        }

        .city-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .city-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .arrow {
            display: flex;
            align-items: center;
            font-size: 24px;
            color: #3b82f6;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: white;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 3px solid #3b82f6;
            overflow: hidden;
            touch-action: none;
        }

        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .endpoint {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .start-point {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .end-point {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .progress-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .progress-indicator {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 20px;
            background: #d1fae5;
            border-radius: 12px;
        }

        .success-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .promo-banner {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 12px;
            margin-top: 20px;
        }

        .promo-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .promo-code {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .hint-text {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="captcha-container">
        <div class="brand-header">
            <div class="brand-logo">‚úàÔ∏è</div>
            <div class="brand-name">JetQuest</div>
            <div class="brand-tagline">Your Journey Awaits</div>
        </div>

        <div class="success-message" id="successMessage">
            <div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-size: 18px; font-weight: 700; color: #10b981;">Route Complete!</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">Redirecting...</div>
        </div>

        <div id="gameContent">
            <div class="game-title">Plan your flight route</div>
            <div class="instructions">Draw a path from departure to arrival</div>

            <div class="route-info" id="routeInfo"></div>

            <div class="progress-display">
                <div class="progress-text">Flight Progress</div>
                <div class="progress-indicator">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="drawCanvas"></canvas>
                <div class="endpoint start-point" id="startPoint">üõ´</div>
                <div class="endpoint end-point" id="endPoint">üõ¨</div>
            </div>

            <div class="hint-text">Drag from departure to arrival city</div>

            <div class="promo-banner" id="promoBanner"></div>
        </div>
    </div>

    <script>
        // City routes with icons and promo codes
        const routes = [
            { from: 'New York', fromIcon: 'üåÜ', to: 'Paris', toIcon: 'üóº', promo: 'JET25', deal: 'Save 25% on European flights' },
            { from: 'Tokyo', fromIcon: 'üóæ', to: 'Sydney', toIcon: 'ü¶ò', promo: 'ASIA30', deal: 'Save 30% on Pacific routes' },
            { from: 'London', fromIcon: 'üè∞', to: 'Dubai', toIcon: 'üïå', promo: 'LUXURY20', deal: 'Save 20% on premium cabins' },
            { from: 'Miami', fromIcon: 'üå¥', to: 'Rio', toIcon: '‚õ±Ô∏è', promo: 'BEACH15', deal: 'Save 15% on beach destinations' },
            { from: 'Singapore', fromIcon: 'üèôÔ∏è', to: 'Bali', toIcon: 'üèùÔ∏è', promo: 'ISLAND25', deal: 'Save 25% on island getaways' }
        ];

        const selectedRoute = routes[Math.floor(Math.random() * routes.length)];

        // Set route info
        document.getElementById('routeInfo').innerHTML = `
            <div class="city">
                <div class="city-icon">${selectedRoute.fromIcon}</div>
                <div class="city-name">${selectedRoute.from}</div>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="city">
                <div class="city-icon">${selectedRoute.toIcon}</div>
                <div class="city-name">${selectedRoute.to}</div>
            </div>
        `;

        // Set promo banner
        document.getElementById('promoBanner').innerHTML = `
            <div class="promo-text">${selectedRoute.deal}:</div>
            <div class="promo-code">${selectedRoute.promo}</div>
        `;

        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // Randomize start and end positions
            const margin = 60;
            const startX = margin + Math.random() * 40;
            const startY = margin + Math.random() * (canvas.height - 2 * margin);
            const endX = canvas.width - margin - Math.random() * 40;
            const endY = margin + Math.random() * (canvas.height - 2 * margin);
            
            startPoint = { x: startX, y: startY };
            endPoint = { x: endX, y: endY };
            
            // Position endpoint elements
            const startEl = document.getElementById('startPoint');
            const endEl = document.getElementById('endPoint');
            startEl.style.left = (startX - 25) + 'px';
            startEl.style.top = (startY - 25) + 'px';
            endEl.style.left = (endX - 25) + 'px';
            endEl.style.top = (endY - 25) + 'px';
        }
        resizeCanvas();

        let isDrawing = false;
        let pathPoints = [];
        let startPoint = { x: 40, y: canvas.height / 2 };
        let endPoint = { x: canvas.width - 40, y: canvas.height / 2 };

        function playSound(frequency, duration = 0.1) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // Ignore audio errors
            }
        }

        function vibrate(duration = 10) {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDrawing);
        
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', endDrawing);

        function startDrawing(e) {
            e.preventDefault();
            const point = getPoint(e);
            
            // Check if starting near start point - MUCH more lenient
            const distToStart = Math.hypot(point.x - startPoint.x, point.y - startPoint.y);
            if (distToStart < 80) { // Increased from 50
                isDrawing = true;
                pathPoints = [point];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                playSound(600);
                vibrate(15);
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const point = getPoint(e);
            pathPoints.push(point);
            
            // Draw line
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (pathPoints.length > 1) {
                const prev = pathPoints[pathPoints.length - 2];
                ctx.beginPath();
                ctx.moveTo(prev.x, prev.y);
                ctx.lineTo(point.x, point.y);
                ctx.stroke();
            }
            
            // Update progress based on distance to end
            const distToEnd = Math.hypot(point.x - endPoint.x, point.y - endPoint.y);
            const totalDist = Math.hypot(endPoint.x - startPoint.x, endPoint.y - startPoint.y);
            const progress = Math.min(100, Math.max(0, 100 - (distToEnd / totalDist * 100)));
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Play subtle sound periodically
            if (pathPoints.length % 5 === 0) {
                playSound(700 + progress * 3, 0.05);
                vibrate(5);
            }
        }

        function endDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const point = getPoint(e);
            const distToEnd = Math.hypot(point.x - endPoint.x, point.y - endPoint.y);
            
            // MUCH more lenient completion check
            if (distToEnd < 80 && pathPoints.length > 10) { // Reduced from 80/15
                completeGame();
            } else {
                // Failed - reset
                playSound(300);
                vibrate([50, 50, 50]);
                resetCanvas();
            }
            
            isDrawing = false;
        }

        function getPoint(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            return {
                x: clientX - rect.left,
                y: clientY - rect.top,
                time: Date.now()
            };
        }

        function resetCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pathPoints = [];
            document.getElementById('progressFill').style.width = '0%';
        }

        function completeGame() {
            playSound(900, 0.2);
            vibrate([20, 50, 20, 50, 20]);
            
            // Draw completion effect
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 6;
            ctx.beginPath();
            pathPoints.forEach((point, i) => {
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();
            
            setTimeout(() => {
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('successMessage').classList.add('show');
                
                setTimeout(() => {
                    window.parent.postMessage('captcha_success', '*');
                }, 1500);
            }, 500);
        }
    </script>
</body>
</html>
